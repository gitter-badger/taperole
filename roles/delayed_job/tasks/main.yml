- name: Install upstart job
  template: src=dj_runner_upstart.j2
            dest=/etc/init/dj_runner_{{app_name}}.conf
  tags: [configure_dj_runner]
  register: dj_runner_installation

- name: register unicorn upstart script
  command: initctl reload-configuration
  when: dj_runner_installation.changed
  tags: [configure_dj_runner]

- name: Give deployer user access to DJ upstart jobs
  lineinfile: 'dest=/etc/sudoers
               state=present
               line="{{deployer_user}} ALL = (root) NOPASSWD: /sbin/{{item}} dj_runner_{{app_name}}"'
  with_items:
    - start
    - stop
    - restart
    - status
  tags: [configure_dj_runner]

# Unfortunately, we can't use the service module for this since we need to
# run the restart task with sudo.  When we use the sudo: option in ansible,
# it runs the entire shell script output from the module with sudo, instead
# of just the command, which causes a 'No sudo password' failure as we only
# allow passwordless sudo for the service commands.
- name: restart delayed job runner
  shell: sudo /sbin/restart dj_runner_{{app_name}}
  remote_user: "{{deployer_user}}"
  sudo_user: root
  when: (dj_runner_installation is defined and dj_runner_installation.changed) or
    force_dj_runner_restart or
    (app_checkout is defined and app_checkout.changed)
  tags: [configure_dj_runner, deploy]
