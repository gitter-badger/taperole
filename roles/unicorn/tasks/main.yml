- name: Install unicorn upstart script
  template: src=unicorn_upstart.j2
            dest=/etc/init/unicorn_{{ app_name}}.conf
  register: unicorn_upstart_installation
  tags: [configure_unicorn]

- name: register unicorn upstart script
  command: initctl reload-configuration
  when: unicorn_upstart_installation.changed
  tags: [configure_unicorn]

- name: Give deployer user access to unicorn upstart jobs
  lineinfile: 'dest=/etc/sudoers
               state=present
               line="{{ deployer_user.name }} ALL = (root) NOPASSWD: /sbin/{{item}} unicorn_{{app_name}}"'
  with_items:
    - start
    - stop
    - restart
    - status
    - reload
  tags: [configure_unicorn]

- name: Set up unicorn log dir
  file: path={{app_path}}/log state=directory owner=deployer
  tags: [configure_unicorn]

- name: Install unicorn config
  template: src=unicorn.rb.j2
            dest={{app_path}}/config/unicorn.rb
  tags: [configure_unicorn]
